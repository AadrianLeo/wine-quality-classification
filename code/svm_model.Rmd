---
title: "SVM Model (Wine Quality)"
author: ""
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
set.seed(123)
```

# Introduction

This document fits a Support Vector Machine (SVM) model with a radial kernel to the cleaned red wine quality data and evaluates its performance.

# Packages

```{r packages}
# If needed, install packages once in the R console, e.g.:
# install.packages(c("here","caret","pROC","dplyr","kernlab"))

library(here)
library(caret)
library(pROC)
library(dplyr)
library(kernlab)  # required for svmRadial in caret
```

# Load Data

```{r load-data}
# 1) Load cleaned data
data_path <- here("data/winequality-red-clean.csv")
wine_model <- read.csv(data_path)

# Ensure target is factor with correct positive class
wine_model$quality_binary <- factor(wine_model$quality_binary,
                                    levels = c("Poor", "Premium"))

# Drop quality_factor if it exists
if ("quality_factor" %in% names(wine_model)) {
  wine_model$quality_factor <- NULL
}

# Sanity checks
stopifnot(all(sapply(dplyr::select(wine_model, -quality_binary), is.numeric)))
stopifnot(!anyNA(wine_model))

str(wine_model)
```

# Train / Validation / Test Split

```{r split-data}
# 2) Train/Validation/Test Split (60/20/20) â€” same split logic as logistic
idx_train <- createDataPartition(wine_model$quality_binary, p = 0.60, list = FALSE)
train <- wine_model[idx_train, ]
temp  <- wine_model[-idx_train, ]

idx_valid <- createDataPartition(temp$quality_binary, p = 0.50, list = FALSE)
valid <- temp[idx_valid, ]
test  <- temp[-idx_valid, ]

sapply(list(train = train, valid = valid, test = test), nrow)
```

# Fit SVM (Radial) Model

```{r fit-svm}
# 3) Fit SVM (Radial) with CV tuning on TRAIN only
# SVM is sensitive to scaling -> preProcess centers/scales predictors
ctrl <- trainControl(
  method = "cv",
  number = 5,
  classProbs = TRUE,
  summaryFunction = twoClassSummary,
  savePredictions = "final"
)

svm_grid <- expand.grid(
  sigma = c(0.005, 0.01, 0.02, 0.05),
  C     = c(0.5, 1, 2, 5, 10)
)

svm_model <- train(
  quality_binary ~ .,
  data = train,
  method = "svmRadial",
  preProcess = c("center", "scale"),
  metric = "ROC",
  trControl = ctrl,
  tuneGrid = svm_grid
)

svm_model
svm_model$bestTune
```

# Predict Probabilities

```{r predict-prob}
# 4) Predict probabilities
valid_prob <- predict(svm_model, newdata = valid, type = "prob")[, "Premium"]
test_prob  <- predict(svm_model, newdata = test,  type = "prob")[, "Premium"]
```

# Choose Threshold (Validation Set)

```{r choose-threshold}
# 5) Choose threshold using Validation set (Youden's J from ROC)
roc_valid <- roc(valid$quality_binary, valid_prob, levels = c("Poor","Premium"), direction = "<")
best <- coords(roc_valid, x = "best", best.method = "youden", transpose = FALSE)
best_thresh <- as.numeric(best["threshold"])
best_thresh
```

# Class Predictions

```{r class-predictions}
# 6) Class predictions using chosen threshold
valid_pred <- factor(ifelse(valid_prob >= best_thresh, "Premium", "Poor"),
                     levels = c("Poor","Premium"))
test_pred  <- factor(ifelse(test_prob  >= best_thresh, "Premium", "Poor"),
                     levels = c("Poor","Premium"))
```

# Model Evaluation

```{r eval-valid}
# 7) Evaluation (Validation)
confusionMatrix(valid_pred, valid$quality_binary, positive = "Premium")
auc_valid <- auc(roc_valid)
auc_valid
```

```{r eval-test}
# 8) Final Evaluation (TEST ONLY)
roc_test <- roc(test$quality_binary, test_prob, levels = c("Poor","Premium"), direction = "<")
auc_test <- auc(roc_test)
auc_test

confusionMatrix(test_pred, test$quality_binary, positive = "Premium")
```

# ROC Plot (Test Set)

```{r roc-plot}
# 9) Optional: ROC plot (test)
plot(roc_test, main = "SVM (Radial) ROC (Test Set)")
```
